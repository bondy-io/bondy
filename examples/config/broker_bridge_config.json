{
    "id": "main",
    "version": "v1.0",
    "kind": "broker_bridge",
    "meta": {},
    "subscriptions" : [
        {
            "bridge": "bondy_kafka_bridge",
            "meta": {
                "description": "Subscribe to com.leapsight.example_event and produce in kafka.topics.wamp_events."
            },
            "match": {
                "realm": "com.leapsight.test",
                "topic" : "com.leapsight.example_event",
                "options": {"match": "exact"}
            },
            "action": {
                "type": "produce_sync",
                "topic": "{{kafka.topics.wamp_events}}",
                "key": "\"{{event.topic}}/{{event.publication_id}}\"",
                "value": "{{event}}",
                "options" : {
                    "client_id": "default",
                    "acknowledge": true,
                    "required_acks": "all",
                    "partition": null,
                    "partitioner": {
                        "algorithm": "fnv32a",
                        "value": "\"{{event.topic}}/{{event.publication_id}}\""
                    },
                    "encoding": "json"
                }
            }
        },
        {
            "bridge": "bondy_aws_sns_bridge",
            "meta": {
                "description": "Subscribe to com.leapsight.test.notification.sms and publish to phone using Amazon SNS."
            },
            "match": {
                "realm": "com.leapsight.test.notification",
                "topic" : "com.leapsight.test.notification.sms",
                "options": {"match": "exact"}
            },
            "action": {
                "phone_number": "{{event.args |> nth(1)}}",
                "text_message": "{{event.args |> nth(2)}}"
            }
        },
        {
            "comment": "Enable Sendgrid or mailgun but not both simultaneously",
            "bridge": "bondy_mailgun_bridge",
            "meta": {
                "description": "Subscribe to com.leapsight.test.notification.email and publish to address using Mailgun."
            },
            "match": {
                "realm": "com.leapsight.test.notification",
                "topic" : "com.leapsight.test.notification.email.deprecated",
                "options": {"match": "exact"}
            },
            "action": {
                "sender": "{{email_sender}}",
                "email_address": "{{event.args |> nth(1)}}",
                "subject": "{{event.args |> nth(2)}}",
                "body": "{{event.args |> nth(3)}}",
                "options": "{{event.kwargs}}"
            }
        },
        {
            "comment": "Enable Sendgrid or mailgun but not both simultaneously",
            "bridge": "bondy_sendgrid_bridge",
            "meta": {
                "description": "Subscribe to com.leapsight.test.notification.email and publish to address using Sendgrid."
            },
            "match": {
                "realm": "com.leapsight.test.notification",
                "topic" : "com.leapsight.test.notification.email",
                "options": {"match": "exact"}
            },
            "action": {
                "sender": "{{email_sender}}",
                "email_address": "{{event.args |> nth(1)}}",
                "subject": "{{event.args |> nth(2)}}",
                "body": "{{event.args |> nth(3)}}",
                "options": "{{event.kwargs}}"
            }
        }
    ]
}
